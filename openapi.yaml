openapi: 3.1.0
info:
  title: Sofia Memory API
  version: 1.0.0
  description: >-
    Минимальное описание публичных методов памяти Софии для интеграции
    внешних сервисов.
  license:
    name: MIT
    url: https://opensource.org/license/mit
servers:
  - url: https://sofia-memory.onrender.com
    description: Render server
security: []
paths:
  /ping:
    get:
      summary: Проверка доступности сервиса
      description: Быстрый health-check; при успешной работе возвращает JSON с полем состояния.
      operationId: ping
      responses:
        '200':
          description: Сервис отвечает и готов принимать запросы.
          content:
            application/json:
              schema:
                type: object
                required: [ok, message]
                properties:
                  ok:
                    type: boolean
                    description: Признак доступности сервиса.
                  message:
                    type: string
                    description: Сообщение-подтверждение.
              example:
                ok: true
                message: pong
        '400':
          description: Неверный запрос (например, некорректный HTTP-метод).
        '503':
          description: Сервис временно недоступен.
  /api/memory/save:
    post:
      summary: Сохранение памяти пользователя
      description: >-
        Записывает содержимое в файловое хранилище памяти. Если указан GitHub-репозиторий,
        требуется валидный токен (может передаваться в заголовке `Authorization: Bearer <token>`
        или полем `token`).
      operationId: saveMemory
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [id, type, version, data]
              properties:
                id:
                  type: string
                  description: Уникальный идентификатор записи памяти.
                type:
                  type: string
                  description: Тип записи (например, message, note).
                version:
                  type: integer
                  description: Версия сохраняемого объекта.
                data:
                  type: object
                  description: Произвольное содержимое записи.
                repo:
                  type: string
                  description: Полный URL GitHub-репозитория для сохранения.
                userId:
                  type: string
                  description: Идентификатор пользователя, для которого сохраняется память.
                token:
                  type: string
                  description: GitHub-токен (если не передаётся через заголовок Authorization).
            example:
              id: "memory/profile/user.json"
              type: message
              version: 1
              data:
                name: Sofia
                role: assistant
              repo: "https://github.com/org/memory-repo"
              userId: "sofia"
      responses:
        '200':
          description: Результат сохранения. Успех и ошибки (кроме явной недоступности 503) возвращаются со статусом 200.
          content:
            application/json:
              schema:
                type: object
                required: [ok, data]
                properties:
                  ok:
                    type: boolean
                    description: Признак успешного выполнения операции.
                  data:
                    type: object
                    nullable: true
                    description: Сохранённые данные или null при ошибке.
                  error:
                    type: string
                    description: Описание ошибки, если операция завершилась неуспешно.
                  details:
                    type: string
                    nullable: true
                    description: Дополнительные детали (например, сообщение GitHub).
              example:
                ok: true
                data:
                  action: saveMemory
                  filePath: "memory/profile/user.json"
                error: null
                details: null
        '503':
          description: Сервис временно недоступен.
  /api/memory/read:
    post:
      summary: Чтение памяти пользователя
      description: Возвращает содержимое файла памяти. Для JSON-файлов параллельно отдаётся распарсенный объект. Если локальный файл отсутствует, возвращает успешный ответ с `data: { status: "not_found" }`. Поддерживается частичное чтение по диапазону `range=start:bytes`.
      operationId: readMemory
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [id, type, version, data]
              properties:
                id:
                  type: string
                  description: Уникальный идентификатор записи памяти.
                type:
                  type: string
                  description: Тип записи (например, message, note).
                version:
                  type: integer
                  description: Версия запрашиваемого объекта.
                data:
                  type: object
                  description: Дополнительные параметры запроса чтения. Поддерживает диапазон `range` в формате `start:bytes`.
                  properties:
                    includeMeta:
                      type: boolean
                    range:
                      type: string
                      description: "Чтение части файла: start:bytes, start >= 0, bytes > 0"
                repo:
                  type: string
                  description: Полный URL GitHub-репозитория для чтения.
                ref:
                  type: string
                  description: Ветка/commit для GitHub-запроса (может быть также задано в repo как `url#branch`).
                userId:
                  type: string
                  description: Идентификатор пользователя, для которого читается память.
                token:
                  type: string
                  description: GitHub-токен (если не передаётся через заголовок Authorization).
            example:
              id: "memory/profile/user.json"
              type: message
              version: 1
              data:
                includeMeta: true
              userId: "sofia"
      responses:
        '200':
          description: Результат чтения. Успех и ошибки (кроме явной недоступности 503) возвращаются со статусом 200.
          content:
            application/json:
              schema:
                type: object
                required: [ok, data]
                properties:
                  ok:
                    type: boolean
                    description: Признак успешного выполнения операции.
              data:
                type: object
                nullable: true
                description: Прочитанные данные или null, если запись не найдена.
                properties:
                  status:
                    type: string
                  file:
                    type: string
                  size:
                    type: integer
                  chunkStart:
                    type: integer
                  chunkEnd:
                    type: integer
                  truncated:
                    type: boolean
                  encoding:
                    type: string
                    enum: [utf-8, base64]
                  content:
                    type: string
                  json:
                    oneOf:
                      - type: object
                      - type: 'null'
                  error:
                    type: string
                    description: Описание ошибки, если операция завершилась неуспешно.
                  details:
                    type: string
                    nullable: true
                    description: Дополнительные детали (например, сообщение GitHub).
              examples:
                found:
                  summary: Найденная запись
                  value:
                    ok: true
                    data:
                      status: success
                      file: memory/profile/user.json
                      size: 1280
                      chunkStart: 0
                      chunkEnd: 1279
                      truncated: false
                      encoding: utf-8
                      content: "{\"name\":\"Sofia\",\"role\":\"assistant\"}"
                      json:
                        name: Sofia
                        role: assistant
                ranged:
                  summary: Частичное чтение
                  value:
                    ok: true
                    data:
                      status: success
                      file: memory/profile/user.json
                      size: 2048
                      chunkStart: 0
                      chunkEnd: 511
                      truncated: true
                      encoding: base64
                      content: "ZmlsZSBwcmVmaXg..."
                missing:
                  summary: Запись отсутствует
                  value:
                    ok: true
                    data:
                      status: not_found
                      file: memory/profile/user.json
                      size: 0
                      chunkStart: 0
                      chunkEnd: -1
                      truncated: false
                    error: null
                    details: null
        '503':
          description: Сервис временно недоступен.
  /api/readMeta:
    get:
      summary: Получение метаданных файла памяти
      description: Возвращает размер, дату изменения, превью первых байт и информацию о JSON-структуре (если применимо). Поддерживает локальные файлы и GitHub-репозитории.
      operationId: readMeta
      parameters:
        - in: query
          name: filename
          required: true
          description: Путь файла относительно корня (можно также передать как `fileName`).
          schema:
            type: string
            example: memory/profile/user.json
        - in: query
          name: fileName
          required: false
          description: Альтернативное имя параметра `filename`.
          schema:
            type: string
        - in: query
          name: repo
          required: false
          description: URL или `owner/repo` GitHub-репозитория. Если не указан, читается локальный файл.
          schema:
            type: string
            example: https://github.com/example/memory-repo
        - in: query
          name: ref
          required: false
          description: Ветка или commit для GitHub-запроса.
          schema:
            type: string
            example: main
        - in: query
          name: userId
          required: false
          description: Идентификатор пользователя (используется для поиска сохранённого токена).
          schema:
            type: string
            example: sofia
        - in: query
          name: token
          required: false
          description: GitHub-токен (если не передан через заголовок Authorization и требуется GitHub-доступ).
          schema:
            type: string
      responses:
        '200':
          description: Метаданные файла.
          content:
            application/json:
              schema:
                type: object
                properties:
                  status:
                    type: string
                    example: ok
                  file:
                    type: string
                  size:
                    type: integer
                    description: Размер файла в байтах.
                  modifiedAt:
                    type: string
                    nullable: true
                    description: Дата последнего изменения (ISO 8601) при наличии.
                  keysCount:
                    type: integer
                    nullable: true
                    description: Количество корневых ключей (для JSON-объектов) или элементов массива.
                  isJSON:
                    type: boolean
                  preview:
                    type: string
                    description: Превью первых 1–2 КБ контента.
              example:
                status: ok
                file: memory/profile/user.json
                size: 20480
                modifiedAt: '2024-03-01T12:00:00Z'
                keysCount: 5
                isJSON: true
                preview: '{"name":"Sofia","role":"assistant"...}'
        '400':
          description: Ошибка валидации входных параметров.
        '401':
          description: Требуется авторизация для обращения к GitHub.
        '404':
          description: Файл не найден.
