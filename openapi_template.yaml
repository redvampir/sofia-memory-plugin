openapi: 3.1.0
info:
  title: Sofia Memory API
  version: 1.0.0
  description: >-
    Минимальное описание публичных методов памяти Софии для интеграции
    внешних сервисов.
  license:
    name: MIT
    url: https://opensource.org/license/mit
servers:
  - url: {{PUBLIC_BASE_URL}}
    description: Render server
security: []
paths:
  /ping:
    get:
      summary: Проверка доступности сервиса
      description: Быстрый health-check; при успешной работе возвращает JSON с полем состояния.
      operationId: ping
      responses:
        '200':
          description: Сервис отвечает и готов принимать запросы.
          content:
            application/json:
              schema:
                type: object
                required: [ok, message]
                properties:
                  ok:
                    type: boolean
                    description: Признак доступности сервиса.
                  message:
                    type: string
                    description: Сообщение-подтверждение.
              example:
                ok: true
                message: pong
        '400':
          description: Неверный запрос (например, некорректный HTTP-метод).
        '503':
          description: Сервис временно недоступен.
  /save:
    post:
      summary: "[DEPRECATED] Сохранение файлов"
      description: "Устаревший маршрут. Используйте POST /api/files/save."
      deprecated: true
      operationId: legacySave
      responses:
        '200':
          description: Эндпоинт устарел и возвращает рекомендации по миграции.
          headers:
            X-Deprecated-Endpoint:
              description: Признак устаревшего маршрута (всегда true для легаси-путей).
              schema:
                type: string
                example: "true"
          content:
            application/json:
              schema: &deprecatedResponse
                type: object
                properties:
                  ok:
                    type: boolean
                    description: Исходный статус операции (если выполнена).
                  message:
                    type: string
                    description: Рекомендация по миграции на новый путь.
                  deprecated:
                    type: boolean
                    description: Флаг устаревшего эндпоинта.
                  deprecatedMessage:
                    type: string
                    description: Сообщение о планируемом удалении.
                  recommendedEndpoint:
                    type: string
                    description: Новый путь API, на который стоит перейти.
              example:
                ok: true
                message: "Эндпоинт /save устарел и будет удалён в версии 5.0.0. Используйте /api/files/save."
                deprecated: true
                deprecatedMessage: "Эндпоинт /save устарел и будет удалён в версии 5.0.0. Используйте /api/files/save."
                recommendedEndpoint: "/api/files/save"
  /read:
    post:
      summary: "[DEPRECATED] Чтение файлов"
      description: "Устаревший маршрут. Используйте POST /api/files/read."
      deprecated: true
      operationId: legacyRead
      responses:
        '200':
          description: Эндпоинт устарел и возвращает рекомендации по миграции.
          headers:
            X-Deprecated-Endpoint:
              description: Признак устаревшего маршрута (всегда true для легаси-путей).
              schema:
                type: string
                example: "true"
          content:
            application/json:
              schema: *deprecatedResponse
              example:
                ok: true
                message: "Эндпоинт /read устарел и будет удалён в версии 5.0.0. Используйте /api/files/read."
                deprecated: true
                deprecatedMessage: "Эндпоинт /read устарел и будет удалён в версии 5.0.0. Используйте /api/files/read."
                recommendedEndpoint: "/api/files/read"
  /readFile:
    post:
      summary: "[DEPRECATED] Чтение файла"
      description: "Устаревший маршрут. Используйте POST /api/files/read."
      deprecated: true
      operationId: legacyReadFile
      responses:
        '200':
          description: Эндпоинт устарел и возвращает рекомендации по миграции.
          headers:
            X-Deprecated-Endpoint:
              description: Признак устаревшего маршрута (всегда true для легаси-путей).
              schema:
                type: string
                example: "true"
          content:
            application/json:
              schema: *deprecatedResponse
              example:
                ok: true
                message: "Эндпоинт /readFile устарел и будет удалён в версии 5.0.0. Используйте /api/files/read."
                deprecated: true
                deprecatedMessage: "Эндпоинт /readFile устарел и будет удалён в версии 5.0.0. Используйте /api/files/read."
                recommendedEndpoint: "/api/files/read"
  /saveMemory:
    post:
      summary: "[DEPRECATED] Сохранение памяти"
      description: "Устаревший маршрут. Используйте POST /api/memory/save."
      deprecated: true
      operationId: legacySaveMemory
      responses:
        '200':
          description: Эндпоинт устарел и возвращает рекомендации по миграции.
          headers:
            X-Deprecated-Endpoint:
              description: Признак устаревшего маршрута (всегда true для легаси-путей).
              schema:
                type: string
                example: "true"
          content:
            application/json:
              schema: *deprecatedResponse
              example:
                ok: true
                message: "Эндпоинт /saveMemory устарел и будет удалён в версии 5.0.0. Используйте /api/memory/save."
                deprecated: true
                deprecatedMessage: "Эндпоинт /saveMemory устарел и будет удалён в версии 5.0.0. Используйте /api/memory/save."
                recommendedEndpoint: "/api/memory/save"
  /readMemory:
    post:
      summary: "[DEPRECATED] Чтение памяти"
      description: "Устаревший маршрут. Используйте POST /api/memory/read."
      deprecated: true
      operationId: legacyReadMemory
      responses:
        '200':
          description: Эндпоинт устарел и возвращает рекомендации по миграции.
          headers:
            X-Deprecated-Endpoint:
              description: Признак устаревшего маршрута (всегда true для легаси-путей).
              schema:
                type: string
                example: "true"
          content:
            application/json:
              schema: *deprecatedResponse
              example:
                ok: true
                message: "Эндпоинт /readMemory устарел и будет удалён в версии 5.0.0. Используйте /api/memory/read."
                deprecated: true
                deprecatedMessage: "Эндпоинт /readMemory устарел и будет удалён в версии 5.0.0. Используйте /api/memory/read."
                recommendedEndpoint: "/api/memory/read"
  /memory:
    get:
      summary: "[DEPRECATED] Чтение памяти (GET)"
      description: "Устаревший маршрут. Используйте GET /api/memory/read."
      deprecated: true
      operationId: legacyMemoryGet
      responses:
        '200':
          description: Эндпоинт устарел и возвращает рекомендации по миграции.
          headers:
            X-Deprecated-Endpoint:
              description: Признак устаревшего маршрута (всегда true для легаси-путей).
              schema:
                type: string
                example: "true"
          content:
            application/json:
              schema: *deprecatedResponse
              example:
                ok: true
                message: "Эндпоинт /memory устарел и будет удалён в версии 5.0.0. Используйте /api/memory/read."
                deprecated: true
                deprecatedMessage: "Эндпоинт /memory устарел и будет удалён в версии 5.0.0. Используйте /api/memory/read."
                recommendedEndpoint: "/api/memory/read"
  /saveMemoryWithIndex:
    post:
      summary: "[DEPRECATED] Сохранение памяти с обновлением индекса"
      description: "Устаревший маршрут. Используйте POST /api/memory/save-with-index."
      deprecated: true
      operationId: legacySaveMemoryWithIndex
      responses:
        '200':
          description: Эндпоинт устарел и возвращает рекомендации по миграции.
          headers:
            X-Deprecated-Endpoint:
              description: Признак устаревшего маршрута (всегда true для легаси-путей).
              schema:
                type: string
                example: "true"
          content:
            application/json:
              schema: *deprecatedResponse
              example:
                ok: true
                message: "Эндпоинт /saveMemoryWithIndex устарел и будет удалён в версии 5.0.0. Используйте /api/memory/save-with-index."
                deprecated: true
                deprecatedMessage: "Эндпоинт /saveMemoryWithIndex устарел и будет удалён в версии 5.0.0. Используйте /api/memory/save-with-index."
                recommendedEndpoint: "/api/memory/save-with-index"
  /loadMemoryToContext:
    post:
      summary: "[DEPRECATED] Загрузка памяти в контекст"
      description: "Устаревший маршрут. Используйте POST /api/memory/load-to-context."
      deprecated: true
      operationId: legacyLoadMemoryToContext
      responses:
        '200':
          description: Эндпоинт устарел и возвращает рекомендации по миграции.
          headers:
            X-Deprecated-Endpoint:
              description: Признак устаревшего маршрута (всегда true для легаси-путей).
              schema:
                type: string
                example: "true"
          content:
            application/json:
              schema: *deprecatedResponse
              example:
                ok: true
                message: "Эндпоинт /loadMemoryToContext устарел и будет удалён в версии 5.0.0. Используйте /api/memory/load-to-context."
                deprecated: true
                deprecatedMessage: "Эндпоинт /loadMemoryToContext устарел и будет удалён в версии 5.0.0. Используйте /api/memory/load-to-context."
                recommendedEndpoint: "/api/memory/load-to-context"
  /loadContextFromIndex:
    post:
      summary: "[DEPRECATED] Загрузка контекста из индекса"
      description: "Устаревший маршрут. Используйте POST /api/memory/load-from-index."
      deprecated: true
      operationId: legacyLoadContextFromIndex
      responses:
        '200':
          description: Эндпоинт устарел и возвращает рекомендации по миграции.
          headers:
            X-Deprecated-Endpoint:
              description: Признак устаревшего маршрута (всегда true для легаси-путей).
              schema:
                type: string
                example: "true"
          content:
            application/json:
              schema: *deprecatedResponse
              example:
                ok: true
                message: "Эндпоинт /loadContextFromIndex устарел и будет удалён в версии 5.0.0. Используйте /api/memory/load-from-index."
                deprecated: true
                deprecatedMessage: "Эндпоинт /loadContextFromIndex устарел и будет удалён в версии 5.0.0. Используйте /api/memory/load-from-index."
                recommendedEndpoint: "/api/memory/load-from-index"
  /saveLessonPlan:
    post:
      summary: "[DEPRECATED] Сохранение плана урока"
      description: "Устаревший маршрут. Используйте POST /api/lessons/save-plan."
      deprecated: true
      operationId: legacySaveLessonPlan
      responses:
        '200':
          description: Эндпоинт устарел и возвращает рекомендации по миграции.
          headers:
            X-Deprecated-Endpoint:
              description: Признак устаревшего маршрута (всегда true для легаси-путей).
              schema:
                type: string
                example: "true"
          content:
            application/json:
              schema: *deprecatedResponse
              example:
                ok: true
                message: "Эндпоинт /saveLessonPlan устарел и будет удалён в версии 5.0.0. Используйте /api/lessons/save-plan."
                deprecated: true
                deprecatedMessage: "Эндпоинт /saveLessonPlan устарел и будет удалён в версии 5.0.0. Используйте /api/lessons/save-plan."
                recommendedEndpoint: "/api/lessons/save-plan"
  /setMemoryRepo:
    post:
      summary: "[DEPRECATED] Настройка репозитория памяти"
      description: "Устаревший маршрут. Используйте POST /api/system/switch_repo."
      deprecated: true
      operationId: legacySetMemoryRepo
      responses:
        '200':
          description: Эндпоинт устарел и возвращает рекомендации по миграции.
          headers:
            X-Deprecated-Endpoint:
              description: Признак устаревшего маршрута (всегда true для легаси-путей).
              schema:
                type: string
                example: "true"
          content:
            application/json:
              schema: *deprecatedResponse
              example:
                ok: true
                message: "Эндпоинт /setMemoryRepo устарел и будет удалён в версии 5.0.0. Используйте /api/system/switch_repo."
                deprecated: true
                deprecatedMessage: "Эндпоинт /setMemoryRepo устарел и будет удалён в версии 5.0.0. Используйте /api/system/switch_repo."
                recommendedEndpoint: "/api/system/switch_repo"
  /status:
    get:
      summary: "[DEPRECATED] Состояние системы"
      description: "Устаревший маршрут. Используйте GET /api/system/status."
      deprecated: true
      operationId: legacyStatusGet
      responses:
        '200':
          description: Эндпоинт устарел и возвращает рекомендации по миграции.
          headers:
            X-Deprecated-Endpoint:
              description: Признак устаревшего маршрута (всегда true для легаси-путей).
              schema:
                type: string
                example: "true"
          content:
            application/json:
              schema: *deprecatedResponse
              example:
                ok: true
                message: "Эндпоинт /status устарел и будет удалён в версии 5.0.0. Используйте /api/system/status."
                deprecated: true
                deprecatedMessage: "Эндпоинт /status устарел и будет удалён в версии 5.0.0. Используйте /api/system/status."
                recommendedEndpoint: "/api/system/status"
    post:
      summary: "[DEPRECATED] Состояние системы"
      description: "Устаревший маршрут. Используйте POST /api/system/status."
      deprecated: true
      operationId: legacyStatusPost
      responses:
        '200':
          description: Эндпоинт устарел и возвращает рекомендации по миграции.
          headers:
            X-Deprecated-Endpoint:
              description: Признак устаревшего маршрута (всегда true для легаси-путей).
              schema:
                type: string
                example: "true"
          content:
            application/json:
              schema: *deprecatedResponse
              example:
                ok: true
                message: "Эндпоинт /status устарел и будет удалён в версии 5.0.0. Используйте /api/system/status."
                deprecated: true
                deprecatedMessage: "Эндпоинт /status устарел и будет удалён в версии 5.0.0. Используйте /api/system/status."
                recommendedEndpoint: "/api/system/status"
  /api/memory/save:
    post:
      summary: Сохранение памяти пользователя
      description: >-
        Записывает содержимое в файловое хранилище памяти. Если указан GitHub-репозиторий,
        требуется валидный токен (может передаваться в заголовке `Authorization: Bearer <token>`
        или полем `token`).
      operationId: saveMemory
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [filename, content]
              properties:
                filename:
                  type: string
                  description: Путь файла относительно корня памяти (например, memory/profile/user.json).
                content:
                  type: string
                  description: Сохраняемый текст или JSON.
                repo:
                  type: string
                  format: uri
                  description: URL GitHub-репозитория для удалённого сохранения (опционально).
                token:
                  type: string
                  description: GitHub-токен для записи (опционально, может быть передан в заголовке Authorization).
                userId:
                  type: string
                  description: Идентификатор пользователя/агента, если используется множественное хранилище.
            example:
              filename: memory/profile/user.json
              content: '{"name":"Sofia","role":"assistant"}'
              repo: https://github.com/example/memory-repo
      responses:
        '200':
          description: Запись сохранена.
          content:
            application/json:
              schema:
                type: object
                properties:
                  status:
                    type: string
                  action:
                    type: string
                  filePath:
                    type: string
              example:
                status: success
                action: saveMemory
                filePath: memory/profile/user.json
        '400':
          description: Неверные входные данные (например, отсутствуют обязательные поля).
        '401':
          description: Отсутствует или неверный GitHub-токен при работе с удалённым репозиторием.
        '404':
          description: Репозиторий не найден (для удалённого режима).
  /api/memory/read:
    post:
      summary: Чтение памяти пользователя
      description: |-
        Возвращает содержимое файла памяти. Для JSON-файлов параллельно отдаётся распарсенный объект.
        Если локальный файл отсутствует, возвращает успешный ответ с `data: { status: "not_found" }`.
        Поддерживается частичное чтение по диапазону `range=start:bytes`.
      operationId: readMemory
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [filename]
              properties:
                filename:
                  type: string
                  description: Путь файла относительно корня памяти (например, memory/profile/user.json).
                range:
                  type: string
                  description: "Диапазон байт в формате start:bytes (start >= 0, bytes > 0). Возвращает часть файла."
                repo:
                  type: string
                  format: uri
                  description: URL GitHub-репозитория для чтения (опционально).
                ref:
                  type: string
                  description: Ветка/commit для GitHub-запроса (можно указать также как `repo#branch`).
                token:
                  type: string
                  description: GitHub-токен для чтения (опционально, может быть передан в заголовке Authorization).
                userId:
                  type: string
                  description: Идентификатор пользователя/агента, если используется множественное хранилище.
            example:
              filename: memory/profile/user.json
              repo: https://github.com/example/memory-repo
      responses:
        '200':
          description: Найденная запись или отсутствие локального файла.
          content:
            application/json:
              schema:
                oneOf:
                  - type: object
                    properties:
                      status:
                        type: string
                      file:
                        type: string
                      size:
                        type: integer
                      chunkStart:
                        type: integer
                      chunkEnd:
                        type: integer
                      truncated:
                        type: boolean
                      encoding:
                        type: string
                        enum: [utf-8, base64]
                      content:
                        type: string
                        description: Содержимое файла (UTF-8 или base64 в зависимости от encoding).
                      json:
                        description: Распарсенный JSON, если файл в формате JSON.
                        oneOf:
                          - type: object
                          - type: 'null'
                  - type: object
                    properties:
                      ok:
                        type: boolean
                        description: Признак успешного ответа при отсутствии локального файла.
                      data:
                        description: Отсутствующее содержимое файла.
                        nullable: true
                        type: 'null'
              examples:
                found:
                  summary: Найденный файл (полное чтение)
                  value:
                    status: success
                    file: memory/profile/user.json
                    size: 1280
                    chunkStart: 0
                    chunkEnd: 1279
                    truncated: false
                    encoding: utf-8
                    content: '{"name":"Sofia","role":"assistant"}'
                    json:
                      name: Sofia
                      role: assistant
                ranged:
                  summary: Частичное чтение
                  value:
                    status: success
                    file: memory/profile/user.json
                    size: 10240
                    chunkStart: 0
                    chunkEnd: 511
                    truncated: true
                    encoding: base64
                    content: "ZmlsZSBwcmVmaXg..."
                missing:
                  summary: Локальный файл отсутствует
                  value:
                    ok: true
                    data:
                      status: not_found
                      file: memory/profile/user.json
                      size: 0
                      chunkStart: 0
                      chunkEnd: -1
                      truncated: false
        '401':
          description: Отсутствует или неверный GitHub-токен при работе с удалённым репозиторием.
        '404':
          description: Репозиторий или удалённый файл не найдены.
  /api/readMeta:
    get:
      summary: Получение метаданных файла памяти
      description: Возвращает размер, дату изменения, превью первых байт и информацию о JSON-структуре (если применимо). Поддерживает локальные файлы и GitHub-репозитории.
      operationId: readMeta
      parameters:
        - in: query
          name: filename
          required: true
          description: Путь файла относительно корня (можно также передать как `fileName`).
          schema:
            type: string
            example: memory/profile/user.json
        - in: query
          name: fileName
          required: false
          description: Альтернативное имя параметра `filename`.
          schema:
            type: string
        - in: query
          name: repo
          required: false
          description: |
            URL или `owner/repo` GitHub-репозитория. Можно указать ветку или commit через `owner/repo#ref`.
            Если не указан, читается локальный файл.
          schema:
            type: string
            example: https://github.com/example/memory-repo
        - in: query
          name: ref
          required: false
          description: Ветка или commit для GitHub-запроса.
          schema:
            type: string
            example: main
        - in: query
          name: userId
          required: false
          description: Идентификатор пользователя (используется для поиска сохранённого токена).
          schema:
            type: string
            example: sofia
        - in: query
          name: token
          required: false
          description: GitHub-токен (если не передан через заголовок Authorization и требуется GitHub-доступ).
          schema:
            type: string
      responses:
        '200':
          description: Метаданные файла.
          content:
            application/json:
              schema:
                type: object
                properties:
                  status:
                    type: string
                    example: ok
                  file:
                    type: string
                  size:
                    type: integer
                    description: Размер файла в байтах.
                  modifiedAt:
                    type: string
                    nullable: true
                    description: Дата последнего изменения (ISO 8601) при наличии.
                  keysCount:
                    type: integer
                    nullable: true
                    description: Количество корневых ключей (для JSON-объектов) или элементов массива.
                  isJSON:
                    type: boolean
                  preview:
                    type: string
                    description: Превью первых 1–2 КБ контента.
              example:
                status: ok
                file: memory/profile/user.json
                size: 20480
                modifiedAt: '2024-03-01T12:00:00Z'
                keysCount: 5
                isJSON: true
                preview: '{"name":"Sofia","role":"assistant"...}'
        '400':
          description: Ошибка валидации входных параметров.
        '401':
          description: Требуется авторизация для обращения к GitHub.
        '404':
          description: Файл не найден.
