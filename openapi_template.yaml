openapi: 3.1.0
info:
  title: Sofia Memory API
  version: 1.0.0
  description: >-
    Минимальное описание публичных методов памяти Софии для интеграции
    внешних сервисов.
  license:
    name: MIT
    url: https://opensource.org/license/mit
servers:
  - url: {{PUBLIC_BASE_URL}}
    description: Render server
security: []
paths:
  /ping:
    get:
      summary: Проверка доступности сервиса
      description: Быстрый health-check; при успешной работе возвращает JSON с полем состояния.
      operationId: ping
      responses:
        '200':
          description: Сервис отвечает и готов принимать запросы.
          content:
            application/json:
              schema:
                type: object
                required: [ok, message]
                properties:
                  ok:
                    type: boolean
                    description: Признак доступности сервиса.
                  message:
                    type: string
                    description: Сообщение-подтверждение.
              example:
                ok: true
                message: pong
        '400':
          description: Неверный запрос (например, некорректный HTTP-метод).
        '503':
          description: Сервис временно недоступен.
  /api/memory/save:
    post:
      summary: Сохранение памяти пользователя
      description: >-
        Записывает содержимое в файловое хранилище памяти. Если указан GitHub-репозиторий,
        требуется валидный токен (может передаваться в заголовке `Authorization: Bearer <token>`
        или полем `token`).
      operationId: saveMemory
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [filename, content]
              properties:
                filename:
                  type: string
                  description: Путь файла относительно корня памяти (например, memory/profile/user.json).
                content:
                  type: string
                  description: Сохраняемый текст или JSON.
                repo:
                  type: string
                  format: uri
                  description: URL GitHub-репозитория для удалённого сохранения (опционально).
                token:
                  type: string
                  description: GitHub-токен для записи (опционально, может быть передан в заголовке Authorization).
                userId:
                  type: string
                  description: Идентификатор пользователя/агента, если используется множественное хранилище.
            example:
              filename: memory/profile/user.json
              content: '{"name":"Sofia","role":"assistant"}'
              repo: https://github.com/example/memory-repo
      responses:
        '200':
          description: Запись сохранена.
          content:
            application/json:
              schema:
                type: object
                properties:
                  status:
                    type: string
                  action:
                    type: string
                  filePath:
                    type: string
              example:
                status: success
                action: saveMemory
                filePath: memory/profile/user.json
        '400':
          description: Неверные входные данные (например, отсутствуют обязательные поля).
        '401':
          description: Отсутствует или неверный GitHub-токен при работе с удалённым репозиторием.
        '404':
          description: Репозиторий не найден (для удалённого режима).
  /api/memory/read:
    post:
      summary: Чтение памяти пользователя
      description: Возвращает содержимое файла памяти. Для JSON-файлов параллельно отдаётся распарсенный объект. Если локальный файл отсутствует, возвращает успешный ответ с `data: null`.
      operationId: readMemory
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [filename]
              properties:
                filename:
                  type: string
                  description: Путь файла относительно корня памяти (например, memory/profile/user.json).
                repo:
                  type: string
                  format: uri
                  description: URL GitHub-репозитория для чтения (опционально).
                token:
                  type: string
                  description: GitHub-токен для чтения (опционально, может быть передан в заголовке Authorization).
                userId:
                  type: string
                  description: Идентификатор пользователя/агента, если используется множественное хранилище.
            example:
              filename: memory/profile/user.json
              repo: https://github.com/example/memory-repo
      responses:
        '200':
          description: Найденная запись или отсутствие локального файла.
          content:
            application/json:
              schema:
                oneOf:
                  - type: object
                    properties:
                      status:
                        type: string
                      content:
                        type: string
                        description: Содержимое файла.
                      json:
                        description: Распарсенный JSON, если файл в формате JSON.
                        oneOf:
                          - type: object
                          - type: 'null'
                  - type: object
                    properties:
                      ok:
                        type: boolean
                        description: Признак успешного ответа при отсутствии локального файла.
                      data:
                        description: Отсутствующее содержимое файла.
                        nullable: true
                        type: 'null'
              examples:
                found:
                  summary: Найденный файл
                  value:
                    status: success
                    content: '{"name":"Sofia","role":"assistant"}'
                    json:
                      name: Sofia
                      role: assistant
                missing:
                  summary: Локальный файл отсутствует
                  value:
                    ok: true
                    data: null
        '401':
          description: Отсутствует или неверный GitHub-токен при работе с удалённым репозиторием.
        '404':
          description: Репозиторий или удалённый файл не найдены.
