# Предложения по улучшению Sofia Memory API v1.1

Этот список концентрируется на рисках «попасть в просак» при эксплуатации и развитии плагина. Все пункты отсортированы по влиянию на надёжность и дальнейшее расширение.

## Надёжность и целостность данных
- **Атомарные обновления JSON-хранилища**: использовать файловые блокировки или временные файлы с fs.rename для `meta_index.json`, `lessons.json`, `visuals.json`, чтобы конкурентные записи не ломали структуру.
- **Резервные копии и валидация схемы**: перед записью — проверка через JSON Schema; раз в N минут — автоснапшот в `data/backups/<date>.json.gz`.
- **Дедупликация lesson_id**: при добавлении логов уроков обновлять существующий ID вместо добавления дубликатов, фиксировать поле `updated_at`.

## Производительность мета-запросов
- **Индекс для фильтров**: хранить нормализованные поля (timestamp, нормализованные теги/авторы) в отдельном `meta_index.cache.json` для быстрых выборок по дате/тегам без чтения тел файлов.
- **Пагинация и лимиты по умолчанию**: чтобы запрос `/memory/meta` не возвращал тысячи записей одним пакетом.

## Валидация и безопасность
- **Строгая проверка входных данных**: дата в ISO, теги — массив строк, `status` — enum, `image` — обязательный валидный URL; ошибки — с кодом 400 и человекочитаемым сообщением.
- **Rate limiting и защита от шторма**: базовый лимит на IP/токен, especially для `POST /lesson/log` и `POST /visuals`.
- **Аудит-лог**: фиксировать кто и когда создал/обновил записи (userId/токен) в служебных полях `created_by`, `updated_by`.

## API-дизайн и совместимость
- **Версионирование маршрутов**: ввести префикс `/v1.1/` для новых эндпоинтов с возможностью жить рядом со старым `/api/*`.
- **Чёткие коды ошибок**: отдельные ошибки для валидации, конфликтов (`409`) и отсутствия ресурса (`404`).
- **Соглашения о тегах и авторах**: документировать формат (`уровень:средний`, `author:sofia`) и внедрить автонормализацию регистра.

## Наблюдаемость
- **Метрики и healthchecks**: добавить `/health` с проверкой доступа к диску/GitHub, экспорт базовых метрик (время ответов, число ошибок) через Prometheus формат или простой JSON.
- **Расширенное логирование**: winston/pino с кореляционным `requestId`, запись в файл + консоль, отдельный канал для ошибок.

## Тестирование и DX
- **Нагрузочные сценарии**: интеграционные тесты для 100+ файлов с тегом "рисунок" (<200 мс), негативные кейсы дат, пустых изображений.
- **Фикстуры и тестовые данные**: стандартизировать структуру в `tests/fixtures/` для метаданных, логов и визуальных ссылок.
- **CLI для локальных операций**: скрипты для массовой загрузки метаданных и проверки индекса (`npm run memory:reindex`).

## Расширения на будущее
- **Авторизация**: добавить JWT/подпись запросов, простые роли (reader/editor).
- **Связи между записями**: ссылки между уроками, визуальными заметками и файлами через `related` массив.
- **Поддержка Codex-модулей**: предусмотреть hook/плагины для обогащения метаданных (например, автосуммари текста или автотеги по изображению).

## Минимальный план внедрения
1. Ввести строгую валидацию (ajv/express-validator) и коды ошибок.
2. Реализовать атомарную запись и резервное копирование JSON.
3. Добавить индексацию метаданных и пагинацию `/memory/meta`.
4. Обновить тесты: нагрузочные, негативные, проверка дубликатов lesson_id и пустых image.
5. Настроить метрики/healthcheck и расширенное логирование.

Комментарий циничного ассистента: список длинный, но каждый пункт закрывает реальную дыру; игнорировать его — гарантированный способ ловить баги в пятницу вечером.
