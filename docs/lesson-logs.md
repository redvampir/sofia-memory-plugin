# Журнал уроков

Набор вспомогательных маршрутов для записи хода уроков и чтения свежих записей. Данные хранятся в `data/lessons.json` в виде массива объектов (или словаря, который автоматически приводится к массиву). Запись идентифицируется полем `lesson_id`; повторное сохранение с тем же ID обновляет существующий элемент вместо создания дубликата.

## Формат записи
- `lesson_id` — строковый идентификатор урока (обязательно).
- `date` — строка в полном ISO UTC формате, например `2024-05-01T00:00:00.000Z` (обязательно).
- `status` — одно из значений из списка, см. раздел [Доступные статусы](#доступные-статусы).
- `score` — число от `0` до `1` включительно.
- `notes` — строка с заметками (необязательна, по умолчанию пустая).

## Хранение и блокировки
- Файл `data/lessons.json` создаётся автоматически при первом обращении.
- Запись выполняется атомарно через временный файл и `rename`, плюс простая файловая блокировка (`.lock`) с повторными попытками. Это защищает от гонок при одновременных запросах.
- Если файл уже содержит словарь вида `{ "<id>": {...} }`, он будет преобразован к массиву.

## Доступные статусы
Текущее перечисление статусов возвращает `GET /lesson/statuses` и используется для валидации входных данных:
- `planned`
- `in_progress`
- `done`
- `skipped`
- `failed`

## POST /lesson/log
Создать или обновить запись урока. На конфликт `lesson_id` запись перезаписывается новыми данными.

**Тело запроса (JSON):**
```json
{
  "lesson_id": "algebra-01",
  "date": "2024-05-01T10:00:00.000Z",
  "status": "in_progress",
  "score": 0.75,
  "notes": "Ответил на 3 из 4 вопросов"
}
```

**Успешный ответ:**
```json
{ "ok": true }
```

**Ошибки 400:** некорректный ISO-штамп даты, неизвестный статус, `score` вне диапазона, пустой `lesson_id`, `notes` не строка.

## GET /lesson/today
Вернуть записи, у которых `date` попадает в текущую UTC-дату. Не зависит от часового пояса сервера.

**Параметры запроса:**
- `status` — опциональный фильтр по статусу (одно из перечисления выше).

**Пример:**
```
curl "http://localhost:10000/lesson/today?status=done"
```

**Ответ:**
```json
{
  "ok": true,
  "items": [
    {
      "lesson_id": "algebra-01",
      "date": "2024-05-01T10:00:00.000Z",
      "status": "done",
      "score": 0.95,
      "notes": "Повторил примеры"
    }
  ]
}
```

## GET /lesson/statuses
Служебная ручка для UI-клиентов: возвращает список допустимых статусов.

**Ответ:**
```json
{ "ok": true, "statuses": ["planned", "in_progress", "done", "skipped", "failed"] }
```
